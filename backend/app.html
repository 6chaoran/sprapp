<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- favicon -->
    <link rel="shortcut icon" type="image/png" sizes="32x32" href="/favicon/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
    <title>Singapore PR Profile Estimator</title>
    <!-- Vue CDN -->
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <!-- Vuetify CDN -->
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.1/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.1/dist/vuetify.min.js"></script>
    <!-- Axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@5.9.55/css/materialdesignicons.min.css">
</head>

<body>
    <div id="app">
        <v-app>
            <v-app-bar app color="primary" dense dark>{{ title }}</v-app-bar>
            <v-main>
                <v-container>
                    <v-row>
                        <div id="test1"></div>
                    </v-row>
                    <!-- text input -->
                    <v-row class="mx-1 my-3">
                        <v-textarea v-model="message" :append-icon="message ? 'mdi-send' : ''" @click:clear="clear"
                            @click:append="sendMessage" auto-grow clearable rows="1" row-height="15" counter
                            label="Enter your profile here"
                            hint="You are free to input any languages that best describe your profile of Singapore PR application."></v-textarea>
                    </v-row>
                    <v-row v-if="showSpinner" class="progress-container ma-3">
                        <v-progress-circular indeterminate color="primary"></v-progress-circular>
                        <span class="progress-text">Query in progres ...</span>
                    </v-row>

                    <!-- query output -->
                    <div id="output" v-show="showOutput" class="ma-3 mt-6">
                        <v-row>
                            <p style="text-align: justify;">
                                Taking into account the comparable profiles, <br>
                                there is a <span :class="resultStyle">{{ (odds*100)+'%' }}</span> possibility of
                                obtaining Singapore Permanent
                                Resident status,
                                indicating a probable <span :class="resultStyle">{{ decision }}</span> result for your
                                application. The estimated
                                waiting period is <span :class="resultStyle">{{ (duration / 30).toFixed(1) }}</span>
                                months.<span v-if="decision=='pass'">If you've been
                                    waiting more than {{ (duration /30).toFixed(1) }} months, you should have better
                                    chance that your ICA letter is
                                    on the way to you!</span>

                            </p>
                        </v-row>
                        <v-row align="baseline" justify="space-between">
                            <p>The 5 most similar profiles:</p>

                            <v-switch v-model="descLang" prepend-icon="mdi-translate" inset dense true-value="en"
                                false-value="raw" hint="switch language" label="EN"></v-switch>


                        </v-row>
                        <v-row no-gutters v-if="mobileView">
                            <v-col cols='12'>
                                <v-card v-for="(item, index) in matches" :key="index" class="mt-3" elevation="2">
                                    <v-card-text>{{ descLang == 'raw' ? item.desc : item.desc_en }}</v-card-text>
                                    <v-card-text>
                                        <v-row class="px-3" style="align-items: center;">
                                            <v-icon class="mr-1">mdi-calendar</v-icon>{{
                                            item.update_time.substring(0,10) }}
                                            <v-spacer></v-spacer>
                                            <v-icon class="mr-1">mdi-timer-sand</v-icon>
                                            {{ (item.duration/30).toFixed(1) }} months
                                            <v-spacer></v-spacer>
                                            <v-chip text-color="white" :color="statusIconColor(item.result)">
                                                <v-avatar left v-if="item.result=='pass'">
                                                    <v-icon>mdi-checkbox-marked-circle</v-icon>
                                                </v-avatar>
                                                {{ item.result }}
                                            </v-chip>
                                        </v-row>
                                    </v-card-text>
                                </v-card>
                            </v-col>

                        </v-row>
                    </div>
                    <!-- add my record -->
                    <v-row class="mt-12 mx-6" v-show="showOutput">
                        <!-- add record modal -->
                        <v-dialog v-model="dialog1" max-width="500px">
                            <template v-slot:activator="{ on, attrs }">
                                <v-row>
                                    <v-btn color="primary" dark v-bind="attrs" v-on="on" @click="updateEditedItem">
                                        Add my record
                                    </v-btn>
                                </v-row>
                            </template>
                            <v-card>
                                <v-card-title>
                                    <span class="text-h5">New Record</span>
                                </v-card-title>
                                <v-card-text>
                                    <v-form v-model="addFormValid">
                                        <v-container>
                                            <v-row>
                                                Please provide a valid email to recieve a reminder to update your
                                                status.
                                            </v-row>
                                            <v-row>
                                                <v-text-field label="User Name" v-model="editedItem.username"
                                                    :rules="[rules.required]"></v-text-field>
                                            </v-row>
                                            <v-row><v-text-field label="Password" v-model="editedItem.password"
                                                    hint="used for editing your record, can be as simple as your DOB in form of mmdd"
                                                    type="password" :rules="[rules.required]"></v-text-field></v-row>
                                            <v-row>
                                                <v-text-field v-model="editedItem.email" label="Email"
                                                    :rules="[rules.required, rules.email]"></v-text-field>
                                            </v-row>
                                            <v-row>
                                                <v-textarea auto-grow clearable rows="1" row-height="15"
                                                    v-model="editedItem.description" label="Description"></v-textarea>
                                            </v-row>
                                            <v-row>
                                                <v-menu v-model="menuAppliedDate" :close-on-content-click="false"
                                                    :nudge-right="40" transition="scale-transition" offset-y
                                                    min-width="auto">
                                                    <template v-slot:activator="{ on, attrs }">
                                                        <v-text-field v-model="editedItem.applied_date"
                                                            label="Applied Date" readonly v-bind="attrs"
                                                            v-on="on"></v-text-field>
                                                    </template>
                                                    <v-date-picker v-model="editedItem.applied_date"
                                                        @input="menuAppliedDate = false"></v-date-picker>
                                                </v-menu>
                                            </v-row>
                                            <v-row>
                                                <v-select :items="['pending', 'pass', 'rejected']" label="Status"
                                                    v-model="editedItem.status"></v-select>
                                            </v-row>
                                            <v-row v-if="editedItem.status!='pending'">
                                                <v-menu v-model="menuClosedDate" :close-on-content-click="false"
                                                    :nudge-right="40" transition="scale-transition" offset-y
                                                    min-width="auto">
                                                    <template v-slot:activator="{ on, attrs }">
                                                        <v-text-field v-model="editedItem.closed_date"
                                                            label="Closed Date" readonly v-bind="attrs"
                                                            v-on="on"></v-text-field>
                                                    </template>
                                                    <v-date-picker v-model="editedItem.closed_date"
                                                        @input="menuClosedDate = false"></v-date-picker>
                                                </v-menu>
                                            </v-row>

                                        </v-container>
                                    </v-form>
                                </v-card-text>

                                <v-card-actions>
                                    <v-spacer></v-spacer>
                                    <v-btn color="blue darken-1" text @click="close1">
                                        Cancel
                                    </v-btn>
                                    <v-btn color="blue darken-1" text @click="save" :disabled="!addFormValid">
                                        Save
                                    </v-btn>
                                </v-card-actions>
                            </v-card>
                        </v-dialog>
                    </v-row>

                    <v-row class="mt-12 mx-3">Recent records</v-row>
                    <!-- edit my record -->
                    <v-row class="mt-9 mx-6">
                        <v-dialog v-model="dialog2" max-width="500px">
                            <template v-slot:activator="{ on, attrs }">
                                <v-row>
                                    <v-btn color="primary" dark v-bind="attrs" v-on="on" @click="editRecordUpdate">
                                        Edit my record
                                    </v-btn>
                                </v-row>
                            </template>
                            <v-card>
                                <v-card-title>
                                    <span class="text-h5">Edit Record</span>
                                </v-card-title>
                                <v-card-text>
                                    <v-form v-model="editFormValid">
                                        <v-container>
                                            <v-row>
                                                Please provide a valid email to recieve a reminder to update your
                                                status.
                                            </v-row>
                                            <v-row>
                                                <v-text-field :disabled="userVerified" label="User Name"
                                                    v-model="editedItem.username"
                                                    :rules="[rules.required]"></v-text-field>
                                            </v-row>
                                            <v-row align="baseline">
                                                <v-col cols='8' class="px-0">
                                                    <v-text-field :disabled="userVerified" label="Password"
                                                        v-model="editedItem.password"
                                                        hint="used for editing your record, can be as simple as your DOB in form of mmdd"
                                                        type="password" :rules="[rules.required]"></v-text-field>
                                                </v-col>
                                                <v-col cols='2'>
                                                    <v-btn :disabled="userVerified" rounded @click="verifyUser"
                                                        color="primary">verify</v-btn>
                                                </v-col>

                                            </v-row>
                                            <v-row>
                                                <v-text-field :disabled="userVerified" v-model="editedItem.email"
                                                    label="Email" :rules="[rules.required, rules.email]"></v-text-field>
                                            </v-row>
                                            <v-row>
                                                <v-textarea auto-grow clearable rows="1" row-height="15"
                                                    v-model="editedItem.description" label="Description"></v-textarea>
                                            </v-row>
                                            <v-row>
                                                <v-menu v-model="menuAppliedDate2" :close-on-content-click="false"
                                                    :nudge-right="40" transition="scale-transition" offset-y
                                                    min-width="auto">
                                                    <template v-slot:activator="{ on, attrs }">
                                                        <v-text-field v-model="editedItem.applied_date"
                                                            label="Applied Date" readonly v-bind="attrs"
                                                            v-on="on"></v-text-field>
                                                    </template>
                                                    <v-date-picker v-model="editedItem.applied_date"
                                                        @input="menuAppliedDate2 = false"></v-date-picker>
                                                </v-menu>
                                            </v-row>
                                            <v-row>
                                                <v-select :items="['pending', 'pass', 'rejected']" label="Status"
                                                    v-model="editedItem.status"></v-select>
                                            </v-row>
                                            <v-row v-if="editedItem.status!='pending'">
                                                <v-menu v-model="menuClosedDate2" :close-on-content-click="false"
                                                    :nudge-right="40" transition="scale-transition" offset-y
                                                    min-width="auto">
                                                    <template v-slot:activator="{ on, attrs }">
                                                        <v-text-field v-model="editedItem.closed_date"
                                                            label="Closed Date" readonly v-bind="attrs"
                                                            v-on="on"></v-text-field>
                                                    </template>
                                                    <v-date-picker v-model="editedItem.closed_date"
                                                        @input="menuClosedDate2 = false"></v-date-picker>
                                                </v-menu>
                                            </v-row>

                                        </v-container>
                                    </v-form>
                                </v-card-text>

                                <v-card-actions>
                                    <v-spacer></v-spacer>
                                    <v-btn color="blue darken-1" text @click="close2">
                                        Cancel
                                    </v-btn>
                                    <v-btn color="blue darken-1" text @click="save2"
                                        :disabled="!editFormValid || !userVerified">
                                        Save
                                    </v-btn>
                                </v-card-actions>
                            </v-card>
                        </v-dialog>
                    </v-row>
                    <v-row>
                        <v-col class="mx-3">
                            <v-card v-for="data in tableData" :key="data.id" class="my-3" min-height="30px"
                                elevation="2">
                                <v-card-text>
                                    <v-row class="mx-1">
                                        {{ data.username }}
                                        <v-spacer></v-spacer>
                                        {{ data.datetime }} </v-row>

                                </v-card-text>
                                <v-card-text>{{ data.description }}</v-card-text>
                                <v-card-text>
                                    <v-row class="px-3" align="center">
                                        {{ data.applied_date }} &nbsp; <v-icon>mdi-ray-start-arrow</v-icon>&nbsp; {{ data.status ==
                                        "pending" ? '' : data.closed_date }}
                                        <v-spacer></v-spacer>
                                        <v-chip :color="statusIconColor(data.status)" text-color="white">
                                            <v-avatar left v-if="data.status=='pass'">
                                                <v-icon>mdi-checkbox-marked-circle</v-icon>
                                            </v-avatar>
                                            {{ data.status }}</v-chip></v-row>

                                </v-card-text>

                            </v-card>
                        </v-col>

                    </v-row>


                </v-container>
            </v-main>
        </v-app>
    </div>

    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify(), // Initialize Vuetify
            data() {
                return {
                    message: '',
                    matches: [
                        { 'desc': 1, 'result': 'pass', 'duration': 123, 'update_time': '2023-01-01', 'desc_en': 'eng' },
                        { 'desc': 2, 'result': 'rejected', 'duration': 234, 'update_time': '2023-02-01', 'desc_en': 'eng' }
                    ],
                    duration: 123,
                    decision: 'pass',
                    odds: 0.5,
                    showSpinner: false,
                    showOutput: false,
                    title: null,
                    descLang: 'raw',
                    email: 'test',
                    status: 'pending',
                    tableData: [],
                    tableHeaders: [
                        {
                            text: 'Profile Description', value: 'description', width: "70%", align: "left"
                        },
                        {
                            text: 'Status', value: 'status', width: "10%", align: "left"
                        },
                        {
                            text: 'Update Time', value: 'datetime', width: "20%", align: "right"
                        }
                    ],
                    dialog1: false,
                    dialog2: false,
                    editedIndex: -1,
                    editedItem: {
                        description: "",
                        status: 'pending',
                        datetime: 'dummy',
                        applied_date: (new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000)).toISOString().substr(0, 10),
                        closed_date: (new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000)).toISOString().substr(0, 10),
                        id: '0',
                        email: "",
                        password: "",
                        username: "",
                    },
                    mobileBreakpoint: 600,
                    menuAppliedDate: false,
                    menuClosedDate: false,
                    menuAppliedDate2: false,
                    menuClosedDate2: false,
                    rules: {
                        required: value => !!value || 'Required.',
                        counter: value => value.length <= 20 || 'Max 20 characters',
                        email: value => {
                            const pattern = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
                            return pattern.test(value) || 'Invalid e-mail.'
                        },
                    },
                    addFormValid: false,
                    editFormValid: false,
                    userVerified: false,

                };
            },
            computed: {
                resultStyle() {
                    return this.decision === 'pass' ? 'text-green' : 'text-red';
                },
                formTitle() {
                    return this.editedIndex === -1 ? 'New Record' : 'Edit Record'
                },

                defaultItem() {
                    return {
                        description: this.message,
                        status: 'pending',
                        datetime: 'dummy',
                        applied_date: (new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000)).toISOString().substr(0, 10),
                        closed_date: (new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000)).toISOString().substr(0, 10),
                        id: '0',
                        email: "",
                        password: "",
                        username: ""
                    }
                },

                mobileView() {
                    // return  window.innerWidth <= this.mobileBreakpoint 
                    return true
                },
            },
            mounted() {
                this.getTitle()
                axios.get('/list_records')
                    .then(response => {
                        this.tableData = response.data;
                    })
                    .catch(error => {
                        console.error(error);
                    });

            },

            methods: {
                clear() {
                    this.message = ""
                    this.showSpinner = false
                    this.showOutput = false
                },
                getTitle() {
                    axios.get('/version').then(response => {
                        this.title = response.data
                    }).catch(e => {
                        console.log(e)
                    }).finally(() => { })
                },
                sendMessage() {
                    this.showSpinner = true
                    // Send the message using Axios
                    axios.post('/get_matches', null, {
                        params: {
                            text: this.message
                        },
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                        .then(response => {
                            console.log(response.data);
                            this.matches = response.data.matches
                            this.odds = response.data.odds
                            this.decision = response.data.pred_decision
                            this.duration = response.data.pred_duration
                        })
                        .catch(error => {
                            console.error(error);
                        }).finally(() => {
                            this.showSpinner = false
                            this.showOutput = true
                        });

                },

                async ingestToPineCone() {
                    if (this.editedItem.status == "pending") {
                        console.log("pending result => skip ingestion")
                    } else {
                        const now = (new Date(Date.now() - (new Date()).getTimezoneOffset() * 60000)).toISOString().substr(0, 10)
                        axios.post("/ingest", null, {
                            params: {
                                username: this.editedItem.username,
                                text: this.editedItem.description,
                                status: this.editedItem.status,
                                applied_date: this.editedItem.applied_date,
                                closed_date: this.editedItem.closed_date,
                                update_time: now
                            },
                            headers: {
                                'Accept': 'application/json'
                            }
                        }).then(() => {
                            console.log('ingest to vectordb')
                        }).catch(e => {
                            console.log(e)
                        }).finally(() => { })
                    }

                },

                addRecordToDB(mode = "create") {
                    let ep = mode == "create" ? "/add_record" : "/edit_record"
                    axios.post(ep, null, {
                        params: {
                            username: this.editedItem.username,
                            password: this.editedItem.password,
                            text: this.editedItem.description,
                            email: this.editedItem.email,
                            status: this.editedItem.status,
                            applied_date: this.editedItem.applied_date,
                            closed_date: this.editedItem.closed_date
                        },
                        headers: {
                            'Accept': 'application/json'
                        }
                    }).then(resp => {
                        console.log("adding record to db");
                        console.log(resp.data);
                        if (resp.data != "ok") {
                            window.alert(resp.data)
                        } else {
                            if (mode == "create") {
                                this.close1()
                            } else {
                                this.close2()
                            }

                        }

                    }).catch(e => { }).finally(() => { })
                },

                updateEditedItem() {
                    this.editedItem.description = this.message
                },

                editItem(item) {
                    this.editedIndex = this.tableData.indexOf(item)
                    this.editedItem = Object.assign({}, item)
                    this.dialog = true
                },

                deleteItem(item) {
                    this.editedIndex = this.tableData.indexOf(item)
                    this.editedItem = Object.assign({}, item)
                    this.dialogDelete = true
                },

                deleteItemConfirm() {
                    this.tableData.splice(this.editedIndex, 1)
                    this.closeDelete()
                },

                close1() {
                    this.dialog1 = false
                    this.$nextTick(() => {
                        this.editedItem = Object.assign({}, this.defaultItem)
                        this.editedIndex = -1
                    })
                },

                close2() {
                    this.dialog2 = false
                    this.$nextTick(() => {
                        this.editedItem = Object.assign({}, this.defaultItem)
                        this.editedIndex = -1
                    })
                },

                closeDelete() {
                    this.dialogDelete = false
                    this.$nextTick(() => {
                        this.editedItem = Object.assign({}, this.defaultItem)
                        this.editedIndex = -1
                    })
                },

                sendEmail() {
                    axios.post('/send_email', null, {
                        params: {
                            recipient_email: this.editedItem.email,
                            username: this.editedItem.username,
                            password: this.editedItem.password,
                            applied_date: this.editedItem.applied_date,
                            description: this.editedItem.description,
                            closed_date: this.editedItem.closed_date,
                            status: this.editedItem.status,
                        },
                        headers: {
                            'Accept': 'application/json'
                        }
                    }).then(resp => {
                        console.log("email sent");
                    }).catch(e => { console.log(e) }).finally(() => { })
                },
                save() {
                    this.editedItem.datetime = this.getCurrentTime()
                    if (this.editedIndex > -1) {
                        Object.assign(this.tableData[this.editedIndex], this.editedItem)
                    } else {
                        this.tableData.unshift(this.editedItem)
                    }
                    this.ingestToPineCone()
                    this.addRecordToDB()
                    this.sendEmail()

                },

                save2() {
                    this.editedItem.datetime = this.getCurrentTime()
                    if (this.editedIndex > -1) {
                        Object.assign(this.tableData[this.editedIndex], this.editedItem)
                    } else {
                        this.tableData.unshift(this.editedItem)
                    }
                    this.ingestToPineCone()
                    this.addRecordToDB(mode = "edit")
                    this.sendEmail()

                },

                getCurrentTime() {
                    const currentDate = new Date();

                    const year = currentDate.getFullYear();
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const hours = String(currentDate.getHours()).padStart(2, '0');
                    const minutes = String(currentDate.getMinutes()).padStart(2, '0');
                    const seconds = String(currentDate.getSeconds()).padStart(2, '0');

                    const formattedDate = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;

                    return formattedDate

                },

                statusIconColor(x) {
                    let colors = {
                        pass: 'green',
                        rejected: 'red',
                    }

                    return colors[x] ?? 'primary'
                },

                editRecordUpdate() {
                    this.userVerified = false

                },
                verifyUser() {
                    console.log('verify')
                    axios.post('/verify_user', null, {
                        params: {
                            username: this.editedItem.username,
                            password: this.editedItem.password
                        },
                        headers: {
                            'Accept': 'application/json'
                        }
                    }).then(resp => {
                        row = resp.data
                        if (row) {
                            this.editedItem.email = row['email']
                            this.editedItem.description = row['description']
                            this.editedItem.applied_date = row['applied_date']
                            this.editedItem.closed_date = row['closed_date']
                            this.editedItem.status = row['status']
                            this.userVerified = true
                        } else {
                            window.alert("Invalid username and password combination")
                        }
                    })
                },
            },
        });
    </script>
    <style>
        .text-green {
            color: green;
        }

        .text-red {
            color: red;
        }

        .progress-container {
            display: flex;
            align-items: center;
            /* Align items vertically */
            height: 25px;
            /* Adjust the height as needed */
        }

        .progress-text {
            margin-left: 10px;
            /* Adjust the spacing between the circular progress and the text */
        }

        .v-data-table>.v-data-table__wrapper>table {
            table-layout: fixed;
        }

        .v-data-table>.v-data-table__wrapper>table>thead>tr>th:first-child {
            width: 50%;
        }

        /* .v-data-table>.v-data-table__wrapper>table>tbody>tr>td {
            word-wrap: break-word;
        } */

        /* mobile view */

        .v-data-table--mobile>.v-data-table__wrapper tbody {
            display: flex;
            flex-wrap: wrap;
        }

        .v-data-table-header-mobile th {
            width: 100%;
        }

        .v-data-table__mobile-row {
            justify-content: flex-start;
            align-items: flex-start;
        }

        .v-data-table>.v-data-table__wrapper .v-data-table__mobile-row {
            min-height: 0;
        }

        .v-application--is-ltr .v-data-table__mobile-row__header {
            display: none;
        }

        .v-data-table>.v-data-table__wrapper .v-data-table__mobile-table-row {
            margin: 10px;
            /* border: 1px solid #ededed; */
            display: block;
        }

        .v-application--is-ltr .v-data-table__mobile-row__cell {
            word-break: break-all;
            text-align: left;
        }
    </style>

</body>

</html>